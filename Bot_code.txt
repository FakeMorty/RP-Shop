# -*- coding: utf-8 -*-

import asyncio
import sqlite3
import sys
from datetime import datetime
from typing import Optional

from aiogram import Bot, Dispatcher, F, types
from aiogram.filters import Command, StateFilter
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.storage.memory import MemoryStorage
from aiogram.types import (
    Message, CallbackQuery, InlineKeyboardMarkup, 
    InlineKeyboardButton, InputMediaPhoto
)

# =============================================================================
#  konfiguratsiya
# =============================================================================

# !!!–í–ê–ñ–ù–û!!! –ó–∞–º–µ–Ω–∏—Ç–µ "–í–ê–®_–ë–û–¢_–¢–û–ö–ï–ù" –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ –±–æ—Ç–∞
[cite_start]BOT_TOKEN = "8468997703:AAEfT1VN4gBX6LtMt7bkHk4ctZ0stJy5t-E" # [cite: 43]

[cite_start]MARKET_CHANNEL_ID = -1002558702431 # [cite: 43]
[cite_start]ADMIN_IDS = [5272076117, 1014648750, 6667527307, 7790048968, 1566512661, 5753554084, 6050582147] # [cite: 43]

# =============================================================================
# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ –∏ FSM (–º–∞—à–∏–Ω—ã —Å–æ—Å—Ç–æ—è–Ω–∏–π)
# =============================================================================

[cite_start]bot = Bot(token=BOT_TOKEN) # [cite: 43]
[cite_start]storage = MemoryStorage() # [cite: 43]
[cite_start]dp = Dispatcher(storage=storage) # [cite: 43]

[cite_start]pending_logins = {} # [cite: 43]

# –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞
[cite_start]class ItemStates(StatesGroup): # [cite: 43]
    waiting_for_image = State()
    waiting_for_name = State()
    waiting_for_description = State()
    waiting_for_price = State()

# –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
[cite_start]class AdminStates(StatesGroup): # [cite: 43]
    waiting_for_user_id = State()
    waiting_for_amount = State()
    waiting_for_player_name = State()
    waiting_for_initial_balance = State()

# =============================================================================
# –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö (SQLite)
# =============================================================================

[cite_start]def init_db(): # [cite: 44]
    conn = sqlite3.connect('rp_market.db')
    cursor = conn.cursor()
    
    # –¢–∞–±–ª–∏—Ü–∞ –∏–≥—Ä–æ–∫–æ–≤
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS players (
            user_id INTEGER PRIMARY KEY,
            player_name TEXT NOT NULL,
            balance INTEGER DEFAULT 0,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            player_form TEXT
        )
    [cite_start]''') # [cite: 44, 45]
    
    # –¢–∞–±–ª–∏—Ü–∞ –ª–æ—Ç–æ–≤
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS lots (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            seller_id INTEGER,
            item_name TEXT NOT NULL,
            item_description TEXT,
            price INTEGER NOT NULL,
            image_file_id TEXT,
            message_id INTEGER,
            is_sold BOOLEAN DEFAULT FALSE,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (seller_id) REFERENCES players (user_id)
        )
    [cite_start]''') # [cite: 46, 47]
    
    # –¢–∞–±–ª–∏—Ü–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS transactions (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            from_user_id INTEGER,
            to_user_id INTEGER,
            amount INTEGER,
            transaction_type TEXT,
            description TEXT,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    [cite_start]''') # [cite: 47, 48]
    
    conn.commit()
    conn.close()

[cite_start]def get_player(user_id: int): # [cite: 48]
    conn = sqlite3.connect('rp_market.db')
    cursor = conn.cursor()
    cursor.execute("SELECT user_id, player_name, balance, created_at, player_form FROM players WHERE user_id = ?", (user_id,))
    player = cursor.fetchone()
    conn.close()
    [cite_start]return player # [cite: 49]

[cite_start]def add_player(user_id: int, player_name: str, player_form: str, initial_balance: int = 0): # [cite: 49]
    conn = sqlite3.connect('rp_market.db')
    cursor = conn.cursor()
    cursor.execute(
        "INSERT OR REPLACE INTO players (user_id, player_name, balance, player_form) VALUES (?, ?, ?, ?)",
        (user_id, player_name, initial_balance, player_form)
    )
    conn.commit()
    conn.close()

[cite_start]def update_balance(user_id: int, amount: int): # [cite: 49]
    conn = sqlite3.connect('rp_market.db')
    cursor = conn.cursor()
    cursor.execute(
        "UPDATE players SET balance = balance + ? WHERE user_id = ?",
        (amount, user_id)
    [cite_start]) # [cite: 50]
    conn.commit()
    conn.close()

[cite_start]def get_player_lots(user_id: int): # [cite: 50]
    conn = sqlite3.connect('rp_market.db')
    cursor = conn.cursor()
    cursor.execute(
        "SELECT * FROM lots WHERE seller_id = ? AND is_sold = FALSE",
        (user_id,)
    )
    lots = cursor.fetchall()
    conn.close()
    return lots

[cite_start]def create_lot(seller_id: int, item_name: str, item_description: str, price: int, image_file_id: str): # [cite: 50, 51]
    conn = sqlite3.connect('rp_market.db')
    cursor = conn.cursor()
    cursor.execute(
        "INSERT INTO lots (seller_id, item_name, item_description, price, image_file_id) VALUES (?, ?, ?, ?, ?)",
        (seller_id, item_name, item_description, price, image_file_id)
    )
    lot_id = cursor.lastrowid
    conn.commit()
    conn.close()
    return lot_id

[cite_start]def get_lot(lot_id: int): # [cite: 51]
    conn = sqlite3.connect('rp_market.db')
    cursor = conn.cursor()
    [cite_start]cursor.execute("SELECT * FROM lots WHERE id = ?", (lot_id,)) # [cite: 52]
    lot = cursor.fetchone()
    conn.close()
    return lot

[cite_start]def mark_lot_sold(lot_id: int): # [cite: 52]
    conn = sqlite3.connect('rp_market.db')
    cursor = conn.cursor()
    cursor.execute("UPDATE lots SET is_sold = TRUE WHERE id = ?", (lot_id,))
    conn.commit()
    conn.close()

[cite_start]def delete_lot(lot_id: int): # [cite: 52]
    conn = sqlite3.connect('rp_market.db')
    cursor = conn.cursor()
    cursor.execute("DELETE FROM lots WHERE id = ?", (lot_id,))
    conn.commit()
    conn.close()

[cite_start]def add_transaction(from_user_id: int, to_user_id: int, amount: int, transaction_type: str, description: str): # [cite: 52]
    conn = sqlite3.connect('rp_market.db')
    cursor = conn.cursor()
    cursor.execute(
        "INSERT INTO transactions (from_user_id, to_user_id, amount, transaction_type, description) VALUES (?, ?, ?, ?, ?)",
        (from_user_id, to_user_id, amount, transaction_type, description)
    [cite_start]) # [cite: 53]
    conn.commit()
    conn.close()

[cite_start]def update_lot_message_id(lot_id: int, message_id: int): # [cite: 53]
    conn = sqlite3.connect('rp_market.db')
    cursor = conn.cursor()
    [cite_start]cursor.execute("UPDATE lots SET message_id = ? WHERE id = ?", (message_id, lot_id)) # [cite: 54]
    conn.commit()
    conn.close()

# =============================================================================
# –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
# =============================================================================

[cite_start]def is_admin(user_id: int) -> bool: # [cite: 54]
    return user_id in ADMIN_IDS

[cite_start]def format_number(num: int) -> str: # [cite: 54]
    return f"{num:,}".replace(",", " ")

# –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã
[cite_start]def get_main_menu(): # [cite: 54]
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üí∞ –ú–æ–π –∫–æ—à–µ–ª–µ–∫", callback_data="wallet")],
        [InlineKeyboardButton(text="üõç –ú–æ–∏ –ª–æ—Ç—ã", callback_data="my_lots")],
        [InlineKeyboardButton(text="‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä", callback_data="add_item")],
    ])

[cite_start]def get_admin_menu(): # [cite: 54]
    return InlineKeyboardMarkup(inline_keyboard=[
        [cite_start][InlineKeyboardButton(text="üë§ –î–æ–±–∞–≤–∏—Ç—å –∏–≥—Ä–æ–∫–∞", callback_data="admin_add_player")], # [cite: 55]
        [InlineKeyboardButton(text="üí∞ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å", callback_data="admin_add_money")],
        [InlineKeyboardButton(text="üí∏ –°–ø–∏—Å–∞—Ç—å –±–∞–ª–∞–Ω—Å", callback_data="admin_remove_money")],
        [InlineKeyboardButton(text="üìä –ë–∞–ª–∞–Ω—Å –∏–≥—Ä–æ–∫–∞", callback_data="admin_check_balance")],
        [InlineKeyboardButton(text="üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="admin_stats")],
        [InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥", callback_data="main_menu")]
    ])

[cite_start]def mod_keyboard(user_id): # [cite: 55]
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å", callback_data=f"approve_{user_id}")],
        [InlineKeyboardButton(text="‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å", callback_data=f"deny_{user_id}")]
    [cite_start]]) # [cite: 56]

# =============================================================================
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞
# =============================================================================

[cite_start]async def set_commands(): # [cite: 56]
    basic_commands = [
        types.BotCommand(command="start", description="üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è"),
        types.BotCommand(command="menu", description="üè∞ –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"),
        types.BotCommand(command="wallet", description="üí∞ –ú–æ–π –∫–æ—à–µ–ª–µ–∫"),
        types.BotCommand(command="lots", description="üõç –ú–æ–∏ –ª–æ—Ç—ã"),
        types.BotCommand(command="add", description="‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä"),
        types.BotCommand(command="myform", description="üìã –ú–æ—è –∞–Ω–∫–µ—Ç–∞"),
        [cite_start]types.BotCommand(command="help", description="‚ùì –ü–æ–º–æ—â—å"), # [cite: 57]
        types.BotCommand(command="cancel", description="üîÑ –û—Ç–º–µ–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ"),
        types.BotCommand(command="logout", description="üö™ –í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞"),
    ]
    await bot.set_my_commands(basic_commands)

    admin_commands = basic_commands + [
        types.BotCommand(command="admin", description="üîß –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"),
        types.BotCommand(command="addplayer", description="üë§ –î–æ–±–∞–≤–∏—Ç—å –∏–≥—Ä–æ–∫–∞"),
        types.BotCommand(command="addmoney", description="üí∞ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å"),
        types.BotCommand(command="removemoney", description="üí∏ –°–ø–∏—Å–∞—Ç—å –±–∞–ª–∞–Ω—Å"),
        [cite_start]types.BotCommand(command="checkbalance", description="üìä –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å"), # [cite: 59]
        types.BotCommand(command="stats", description="üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã"),
    [cite_start]] # [cite: 58]
    
    for admin_id in ADMIN_IDS:
        try:
            await bot.set_my_commands(
                admin_commands,
                scope=types.BotCommandScopeChat(chat_id=admin_id)
            [cite_start]) # [cite: 60]
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–æ–º–∞–Ω–¥ –¥–ª—è –∞–¥–º–∏–Ω–∞ {admin_id}: {e}")
            continue

# =============================================================================
# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
# =============================================================================

@dp.message(Command("start"))
[cite_start]async def cmd_start(message: Message): # [cite: 60]
    player = get_player(message.from_user.id)
    
    if player:
        await message.answer(
            "‚ùå –í—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ —Å–∏—Å—Ç–µ–º–µ!\n"
            [cite_start]"–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /menu –¥–ª—è –≤—Ö–æ–¥–∞ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é." # [cite: 61]
        )
        return
    
    await message.answer(
        "üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Ä—ã–Ω–æ–∫ –í–µ—Å—Ç–µ—Ä–æ—Å–∞!\n\n"
        "‚ùóÔ∏è –î–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∞–Ω–∫–µ—Ç—É —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –≤–∞—à–µ–º –ø–µ—Ä—Å–æ–Ω–∞–∂–µ:\n"
        "‚Ä¢ –ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞\n"
        "‚Ä¢ –í–æ–∑—Ä–∞—Å—Ç\n"
        "‚Ä¢ –ö—Ä–∞—Ç–∫–∞—è –±–∏–æ–≥—Ä–∞—Ñ–∏—è\n"
        [cite_start]"‚Ä¢ –†–æ–¥ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏\n\n" # [cite: 62]
        "üìù –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º."
    )

@dp.message(Command("logout"))
[cite_start]async def cmd_logout(message: Message): # [cite: 62]
    if not get_player(message.from_user.id):
        await message.answer("‚ùå –í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ —Å–∏—Å—Ç–µ–º–µ!")
        return
    
    [cite_start]conn = sqlite3.connect('rp_market.db') # [cite: 63]
    cursor = conn.cursor()
    cursor.execute("DELETE FROM lots WHERE seller_id = ?", (message.from_user.id,))
    [cite_start]cursor.execute("DELETE FROM transactions WHERE from_user_id = ? OR to_user_id = ?", (message.from_user.id, message.from_user.id)) # [cite: 64]
    cursor.execute("DELETE FROM players WHERE user_id = ?", (message.from_user.id,))
    conn.commit()
    conn.close()
    
    if message.from_user.id in pending_logins:
        del pending_logins[message.from_user.id]
    
    await message.answer(
        "‚úÖ –í—ã —É—Å–ø–µ—à–Ω–æ –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã!\n"
        "–í—Å–µ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ, –ª–æ—Ç—ã –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —É–¥–∞–ª–µ–Ω—ã.\n"
        [cite_start]"–î–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start" # [cite: 65]
    )

@dp.message(Command("menu"))
[cite_start]async def cmd_menu(message: Message): # [cite: 65]
    player = get_player(message.from_user.id)
    
    if not player:
        await message.answer(
            "‚ùå –í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ —Å–∏—Å—Ç–µ–º–µ!\n"
            [cite_start]"–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏." # [cite: 66]
        )
        return
    
    if not player[4]:
        await message.answer(
            "‚ùå –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –º–µ–Ω—é –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∏–º–µ—Ç—å –æ–¥–æ–±—Ä–µ–Ω–Ω—É—é –∞–Ω–∫–µ—Ç—É!\n"
            "–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∞–Ω–∫–µ—Ç—É –∏ –¥–æ–∂–¥–∏—Ç–µ—Å—å –æ–¥–æ–±—Ä–µ–Ω–∏—è."
        )
        return
    
    await message.answer(
        f"üè∞ –†—ã–Ω–æ–∫ –í–µ—Å—Ç–µ—Ä–æ—Å–∞\n\n"
        f"üë§ {player[1]}\n"
        f"üí∞ –ë–∞–ª–∞–Ω—Å: {format_number(player[2])} –∑–æ–ª–æ—Ç—ã—Ö –º–æ–Ω–µ—Ç\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=get_main_menu()
    [cite_start]) # [cite: 67]

@dp.message(Command("wallet"))
[cite_start]async def cmd_wallet(message: Message): # [cite: 67]
    player = get_player(message.from_user.id)
    
    if not player:
        await message.answer(
            "‚ùå –í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ —Å–∏—Å—Ç–µ–º–µ!\n"
            [cite_start]"–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏." # [cite: 68]
        )
        return
    
    await message.answer(f"üí∞ –í–∞—à –±–∞–ª–∞–Ω—Å: {format_number(player[2])} –∑–æ–ª–æ—Ç—ã—Ö –º–æ–Ω–µ—Ç")

@dp.message(Command("add"))
[cite_start]async def cmd_add(message: Message, state: FSMContext): # [cite: 68]
    player = get_player(message.from_user.id)
    
    if not player:
        [cite_start]await message.answer("‚ùå –í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ —Å–∏—Å—Ç–µ–º–µ!\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.") # [cite: 69]
        return
    
    if not player[4]:
        [cite_start]await message.answer("‚ùå –î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∏–º–µ—Ç—å –æ–¥–æ–±—Ä–µ–Ω–Ω—É—é –∞–Ω–∫–µ—Ç—É!") # [cite: 69]
        return
    
    [cite_start]lots = get_player_lots(message.from_user.id) # [cite: 70]
    if len(lots) >= 5:
        await message.answer(
            "‚ùå –£ –≤–∞—Å —É–∂–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ª–æ—Ç–æ–≤ (5)!\n"
            "–î–æ–∂–¥–∏—Ç–µ—Å—å –ø—Ä–æ–¥–∞–∂–∏ –∏–ª–∏ —Å–Ω–∏–º–∏—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ª–æ—Ç—ã."
        )
        return
    
    [cite_start]await message.answer("üì∏ –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é —Ç–æ–≤–∞—Ä–∞:") # [cite: 71]
    await state.set_state(ItemStates.waiting_for_image)

@dp.message(Command("myform"))
[cite_start]async def cmd_myform(message: Message): # [cite: 81]
    player = get_player(message.from_user.id)
    if not player:
        [cite_start]await message.answer("‚ùå –í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ —Å–∏—Å—Ç–µ–º–µ!\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.") # [cite: 81]
        return
    
    if not player[4]:
        await message.answer(
            "‚ùå –í–∞—à–∞ –∞–Ω–∫–µ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –µ—â–µ –Ω–µ –æ–¥–æ–±—Ä–µ–Ω–∞.\n"
            [cite_start]"–ï—Å–ª–∏ –≤—ã –µ—â–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ –∞–Ω–∫–µ—Ç—É, –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ –µ–µ –≤ —á–∞—Ç." # [cite: 82]
        )
        return
    
    [cite_start]await message.answer(f"üìù –í–∞—à–∞ —Ç–µ–∫—É—â–∞—è –æ–¥–æ–±—Ä–µ–Ω–Ω–∞—è –∞–Ω–∫–µ—Ç–∞:\n\n{player[4]}") # [cite: 83]

@dp.message(Command("cancel"))
[cite_start]async def cmd_cancel(message: Message, state: FSMContext): # [cite: 83]
    current_state = await state.get_state()
    if current_state is not None:
        await state.clear()
        await message.answer(
            "üîÑ –î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /menu –¥–ª—è –≤—Ö–æ–¥–∞ –≤ –º–µ–Ω—é",
            reply_markup=types.ReplyKeyboardRemove()
        [cite_start]) # [cite: 84]
    else:
        await message.answer("‚ùå –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –æ—Ç–º–µ–Ω—ã")

@dp.message(Command("help"))
[cite_start]async def cmd_help(message: Message): # [cite: 79]
    help_text = (
        "üîπ <b>–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>\n"
        "/start - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ —Å–∏—Å—Ç–µ–º–µ\n"
        "/menu - –û—Ç–∫—Ä—ã—Ç—å –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n"
        "/wallet - –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –±–∞–ª–∞–Ω—Å\n"
        [cite_start]"/lots - –ü—Ä–æ—Å–º–æ—Ç—Ä –≤–∞—à–∏—Ö –ª–æ—Ç–æ–≤\n" # [cite: 80]
        "/add - –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä –Ω–∞ –ø—Ä–æ–¥–∞–∂—É\n"
        "/myform - –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ—é –∞–Ω–∫–µ—Ç—É\n"
        "/help - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ\n"
        "/cancel - –û—Ç–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ\n\n"
        "üî∏ <b>–ü—Ä–∞–≤–∏–ª–∞ —Ç–æ—Ä–≥–æ–≤–ª–∏:</b>\n"
        "‚Ä¢ –ú–∞–∫—Å–∏–º—É–º 5 –∞–∫—Ç–∏–≤–Ω—ã—Ö –ª–æ—Ç–æ–≤\n"
        [cite_start]"‚Ä¢ –ù–µ–ª—å–∑—è –ø–æ–∫—É–ø–∞—Ç—å —Å–≤–æ–∏ —Ç–æ–≤–∞—Ä—ã\n\n" # [cite: 81]
        "–ü–æ –≤—Å–µ–º –≤–æ–ø—Ä–æ—Å–∞–º –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º."
    )
    await message.answer(help_text, parse_mode="HTML")

# =============================================================================
# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
# =============================================================================

@dp.message(Command("admin"))
[cite_start]async def cmd_admin(message: Message): # [cite: 71]
    if not is_admin(message.from_user.id):
        await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞!")
        return
    await message.answer("üîß –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:", reply_markup=get_admin_menu())

@dp.message(Command("addplayer"))
[cite_start]async def cmd_addplayer(message: Message, state: FSMContext): # [cite: 71]
    if not is_admin(message.from_user.id):
        [cite_start]await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞!") # [cite: 72]
        return
    await message.answer("üë§ –í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:")
    await state.set_state(AdminStates.waiting_for_user_id)

@dp.message(Command("addmoney"))
[cite_start]async def cmd_addmoney(message: Message, state: FSMContext): # [cite: 72]
    if not is_admin(message.from_user.id):
        await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞!")
        return
    await message.answer("üë§ –í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞:")
    await state.set_state(AdminStates.waiting_for_user_id)
    await state.update_data(action="add_money")

@dp.message(Command("removemoney"))
[cite_start]async def cmd_removemoney(message: Message, state: FSMContext): # [cite: 72]
    if not is_admin(message.from_user.id):
        [cite_start]await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞!") # [cite: 73]
        return
    await message.answer("üë§ –í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞:")
    await state.set_state(AdminStates.waiting_for_user_id)
    await state.update_data(action="remove_money")

@dp.message(Command("checkbalance"))
[cite_start]async def cmd_checkbalance(message: Message): # [cite: 73]
    if not is_admin(message.from_user.id):
        await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞!")
        return
    
    [cite_start]args = message.text.split() # [cite: 74]
    if len(args) < 2:
        await message.answer("‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /checkbalance <user_id>")
        return
    
    try:
        user_id = int(args[1])
        player = get_player(user_id)
        if not player:
            [cite_start]await message.answer(f"‚ùå –ò–≥—Ä–æ–∫ —Å ID {user_id} –Ω–µ –Ω–∞–π–¥–µ–Ω!") # [cite: 74]
            return
        
        await message.answer(
            f"üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏–≥—Ä–æ–∫–µ:\n"
            f"üë§ ID: {user_id}\n"
            f"üé≠ –ò–º—è: {player[1]}\n"
            f"üí∞ –ë–∞–ª–∞–Ω—Å: {format_number(player[2])} –º–æ–Ω–µ—Ç\n"
            f"üìÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: {player[3]}\n"
            [cite_start]f"üìù –ê–Ω–∫–µ—Ç–∞: {'‚úÖ –ï—Å—Ç—å' if player[4] else '‚ùå –ù–µ—Ç'}" # [cite: 76]
        [cite_start]) # [cite: 75]
    except ValueError:
        await message.answer("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!")

@dp.message(Command("stats"))
[cite_start]async def cmd_stats(message: Message): # [cite: 76]
    if not is_admin(message.from_user.id):
        await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞!")
        return
    
    conn = sqlite3.connect('rp_market.db')
    cursor = conn.cursor()
    
    [cite_start]cursor.execute("SELECT COUNT(*) FROM players") # [cite: 77]
    total_players = cursor.fetchone()[0]
    cursor.execute("SELECT COUNT(*) FROM players WHERE player_form IS NOT NULL")
    players_with_forms = cursor.fetchone()[0]
    cursor.execute("SELECT COUNT(*) FROM lots WHERE is_sold = FALSE")
    active_lots = cursor.fetchone()[0]
    cursor.execute("SELECT COUNT(*) FROM lots WHERE is_sold = TRUE")
    sold_lots = cursor.fetchone()[0]
    [cite_start]cursor.execute("SELECT SUM(balance) FROM players") # [cite: 78]
    total_balance = cursor.fetchone()[0] or 0
    cursor.execute("SELECT COUNT(*) FROM transactions")
    total_transactions = cursor.fetchone()[0]
    conn.close()
    
    await message.answer(
        f"üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã:\n\n"
        f"üë• –í—Å–µ–≥–æ –∏–≥—Ä–æ–∫–æ–≤: {total_players}\n"
        f"üìù –° –∞–Ω–∫–µ—Ç–∞–º–∏: {players_with_forms}\n"
        [cite_start]f"üõç –ê–∫—Ç–∏–≤–Ω—ã—Ö –ª–æ—Ç–æ–≤: {active_lots}\n" # [cite: 79]
        f"‚úÖ –ü—Ä–æ–¥–∞–Ω–Ω—ã—Ö –ª–æ—Ç–æ–≤: {sold_lots}\n"
        f"üí∞ –û–±—â–∏–π –±–∞–ª–∞–Ω—Å: {format_number(total_balance)} –º–æ–Ω–µ—Ç\n"
        f"üí∏ –í—Å–µ–≥–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: {total_transactions}"
    )

# =============================================================================
# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ Callback-–∑–∞–ø—Ä–æ—Å–æ–≤ (–Ω–∞–∂–∞—Ç–∏–π –Ω–∞ –∫–Ω–æ–ø–∫–∏)
# =============================================================================

@dp.callback_query(F.data == "main_menu")
[cite_start]async def callback_main_menu(callback: CallbackQuery): # [cite: 105]
    player = get_player(callback.from_user.id)
    if not player:
        await callback.answer("–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")
        return
    
    await callback.message.edit_text(
        f"üè∞ –†—ã–Ω–æ–∫ –í–µ—Å—Ç–µ—Ä–æ—Å–∞\n\n"
        f"üë§ {player[1]}\n"
        [cite_start]f"üí∞ –ë–∞–ª–∞–Ω—Å: {format_number(player[2])} –∑–æ–ª–æ—Ç—ã—Ö –º–æ–Ω–µ—Ç\n\n" # [cite: 106]
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=get_main_menu()
    )
    await callback.answer()

@dp.callback_query(F.data == "wallet")
[cite_start]async def callback_wallet(callback: CallbackQuery): # [cite: 102, 103]
    player = get_player(callback.from_user.id)
    if not player:
        await callback.answer("–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")
        return
    
    await callback.message.edit_text(
        f"üí∞ –í–∞—à –±–∞–ª–∞–Ω—Å: {format_number(player[2])} –∑–æ–ª–æ—Ç—ã—Ö –º–æ–Ω–µ—Ç",
        reply_markup=InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥", callback_data="main_menu")]
        ])
    )
    await callback.answer()

@dp.callback_query(F.data == "my_lots")
[cite_start]async def callback_my_lots(callback: CallbackQuery): # [cite: 103]
    [cite_start]lots = get_player_lots(callback.from_user.id) # [cite: 104]
    
    text = "üõç –í–∞—à–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ –ª–æ—Ç—ã:\n\n" if lots else "üõç –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ª–æ—Ç–æ–≤"
    if lots:
        for lot in lots:
            text += f"üì¶ {lot[2]} - {format_number(lot[4])} –º–æ–Ω–µ—Ç\n"
    
    await callback.message.edit_text(
        text,
        reply_markup=InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥", callback_data="main_menu")]
        [cite_start]]) # [cite: 105]
    )
    await callback.answer()

@dp.callback_query(F.data == "add_item")
[cite_start]async def callback_add_item(callback: CallbackQuery, state: FSMContext): # [cite: 1]
    player = get_player(callback.from_user.id)
    
    if not player[4]:
        await callback.answer("–ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –æ–¥–æ–±—Ä–µ–Ω–Ω–∞—è –∞–Ω–∫–µ—Ç–∞!")
        return
    
    lots = get_player_lots(callback.from_user.id)
    if len(lots) >= 5:
        await callback.message.edit_text(
            [cite_start]"‚ùå –£ –≤–∞—Å —É–∂–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ª–æ—Ç–æ–≤ (5)!\n" # [cite: 2]
            "–î–æ–∂–¥–∏—Ç–µ—Å—å –ø—Ä–æ–¥–∞–∂–∏ –∏–ª–∏ —Å–Ω–∏–º–∏—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ª–æ—Ç—ã.",
            reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥", callback_data="main_menu")]
            ])
        )
        await callback.answer()
        return
    
    [cite_start]await callback.message.edit_text("üì∏ –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é —Ç–æ–≤–∞—Ä–∞:") # [cite: 3]
    await state.set_state(ItemStates.waiting_for_image)
    await callback.answer()

# ----------------- –ü—Ä–æ—Ü–µ—Å—Å –ø–æ–∫—É–ø–∫–∏ -----------------

@dp.callback_query(F.data.startswith("buy_"))
[cite_start]async def handle_buy(callback: CallbackQuery): # [cite: 23]
    lot_id = int(callback.data.split("_")[1])
    buyer_id = callback.from_user.id
    
    lot = get_lot(lot_id)
    if not lot:
        [cite_start]await callback.answer("‚ùå –õ–æ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω!") # [cite: 23]
        return
    
    if lot[7]:
        [cite_start]await callback.answer("‚ùå –¢–æ–≤–∞—Ä —É–∂–µ –ø—Ä–æ–¥–∞–Ω!") # [cite: 24]
        return
    
    if buyer_id == lot[1]:
        await callback.answer("‚ùå –ù–µ–ª—å–∑—è –ø–æ–∫—É–ø–∞—Ç—å —Å–≤–æ–∏ —Ç–æ–≤–∞—Ä—ã!")
        return
    
    [cite_start]buyer = get_player(buyer_id) # [cite: 25]
    if not buyer:
        await callback.answer("‚ùå –í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ —Å–∏—Å—Ç–µ–º–µ!")
        return
    
    if not buyer[4]:
        await callback.answer("‚ùå –ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –æ–¥–æ–±—Ä–µ–Ω–Ω–∞—è –∞–Ω–∫–µ—Ç–∞ –¥–ª—è –ø–æ–∫—É–ø–æ–∫!")
        return
    
    if buyer[2] < lot[4]:
        [cite_start]await callback.answer(f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤! –ù—É–∂–Ω–æ: {format_number(lot[4])} –º–æ–Ω–µ—Ç") # [cite: 26]
        return
    
    # –ü—Ä–æ–≤–µ–¥–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    seller = get_player(lot[1])
    update_balance(buyer_id, -lot[4])
    update_balance(lot[1], lot[4])
    mark_lot_sold(lot_id)
    [cite_start]add_transaction(buyer_id, lot[1], lot[4], "purchase", f"–ü–æ–∫—É–ø–∫–∞ —Ç–æ–≤–∞—Ä–∞: {lot[2]}") # [cite: 27]
    
    # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞–º
    try:
        [cite_start]await bot.send_message(buyer_id, f"‚úÖ –ü–æ–∫—É–ø–∫–∞ —É—Å–ø–µ—à–Ω–∞!\nüì¶ –¢–æ–≤–∞—Ä: {lot[2]}\nüí∞ –°—É–º–º–∞: {format_number(lot[4])} –º–æ–Ω–µ—Ç\nüë§ –ü—Ä–æ–¥–∞–≤–µ—Ü: {seller[1]}") # [cite: 28]
    except: pass
    try:
        [cite_start]await bot.send_message(lot[1], f"üéâ –í–∞—à —Ç–æ–≤–∞—Ä –ø—Ä–æ–¥–∞–Ω!\nüì¶ –¢–æ–≤–∞—Ä: {lot[2]}\nüí∞ –°—É–º–º–∞: {format_number(lot[4])} –º–æ–Ω–µ—Ç\nüë§ –ü–æ–∫—É–ø–∞—Ç–µ–ª—å: {buyer[1]}") # [cite: 29]
    except: pass

    # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∫–∞–Ω–∞–ª–µ
    try:
        new_caption = callback.message.caption + "\n\nüî¥ **–ü–†–û–î–ê–ù–û**"
        [cite_start]await callback.message.edit_caption(caption=new_caption, reply_markup=None, parse_mode="Markdown") # [cite: 30]
    except: pass
    
    await callback.answer("‚úÖ –ü–æ–∫—É–ø–∫–∞ —É—Å–ø–µ—à–Ω–∞!")

# ----------------- –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å: Callbacks -----------------

@dp.callback_query(F.data == "admin_menu")
[cite_start]async def callback_admin_menu(callback: CallbackQuery): # [cite: 20]
    if not is_admin(callback.from_user.id):
        [cite_start]await callback.answer("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞!") # [cite: 21]
        return
    await callback.message.edit_text("üîß –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:", reply_markup=get_admin_menu())
    await callback.answer()

@dp.callback_query(F.data == "admin_add_player")
[cite_start]async def callback_admin_add_player(callback: CallbackQuery, state: FSMContext): # [cite: 12]
    if not is_admin(callback.from_user.id):
        await callback.answer("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞!")
        return
    await callback.message.edit_text("üë§ –í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:")
    [cite_start]await state.set_state(AdminStates.waiting_for_user_id) # [cite: 13]
    await callback.answer()

@dp.callback_query(F.data == "admin_add_money")
[cite_start]async def callback_admin_add_money(callback: CallbackQuery, state: FSMContext): # [cite: 13]
    if not is_admin(callback.from_user.id):
        await callback.answer("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞!")
        return
    await callback.message.edit_text("üë§ –í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞:")
    await state.set_state(AdminStates.waiting_for_user_id)
    await state.update_data(action="add_money")
    await callback.answer()

@dp.callback_query(F.data == "admin_remove_money")
[cite_start]async def callback_admin_remove_money(callback: CallbackQuery, state: FSMContext): # [cite: 13]
    if not is_admin(callback.from_user.id):
        await callback.answer("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞!")
        [cite_start]return # [cite: 14]
    await callback.message.edit_text("üë§ –í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞:")
    await state.set_state(AdminStates.waiting_for_user_id)
    await state.update_data(action="remove_money")
    await callback.answer()

@dp.callback_query(F.data == "admin_check_balance")
[cite_start]async def callback_admin_check_balance(callback: CallbackQuery): # [cite: 14]
    if not is_admin(callback.from_user.id):
        await callback.answer("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞!")
        return
    await callback.message.edit_text(
        [cite_start]"üìä –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–ª–∞–Ω—Å–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É:\n/checkbalance <user_id>\n\n–ù–∞–ø—Ä–∏–º–µ—Ä: /checkbalance 123456789", # [cite: 15]
        reply_markup=InlineKeyboardMarkup(inline_keyboard=[[InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥", callback_data="admin_menu")]])
    )
    await callback.answer()

@dp.callback_query(F.data == "admin_stats")
[cite_start]async def callback_admin_stats(callback: CallbackQuery): # [cite: 15]
    if not is_admin(callback.from_user.id):
        await callback.answer("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞!")
        return
    
    conn = sqlite3.connect('rp_market.db')
    cursor = conn.cursor()
    [cite_start]cursor.execute("SELECT COUNT(*) FROM players") # [cite: 16]
    total_players = cursor.fetchone()[0]
    cursor.execute("SELECT COUNT(*) FROM players WHERE player_form IS NOT NULL")
    players_with_forms = cursor.fetchone()[0]
    cursor.execute("SELECT COUNT(*) FROM lots WHERE is_sold = FALSE")
    active_lots = cursor.fetchone()[0]
    [cite_start]cursor.execute("SELECT COUNT(*) FROM lots WHERE is_sold = TRUE") # [cite: 17]
    sold_lots = cursor.fetchone()[0]
    cursor.execute("SELECT SUM(balance) FROM players")
    total_balance = cursor.fetchone()[0] or 0
    cursor.execute("SELECT COUNT(*) FROM transactions")
    total_transactions = cursor.fetchone()[0]
    cursor.execute("SELECT player_name, balance FROM players ORDER BY balance DESC LIMIT 3")
    top_players = cursor.fetchall()
    conn.close()
    
    [cite_start]top_text = "" # [cite: 18]
    for i, (name, balance) in enumerate(top_players, 1):
        [cite_start]top_text += f"{i}. {name}: {format_number(balance)} –º–æ–Ω–µ—Ç\n" # [cite: 19]
    
    stats_text = (
        f"üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã:\n\n"
        f"üë• –í—Å–µ–≥–æ –∏–≥—Ä–æ–∫–æ–≤: {total_players}\n"
        f"üìù –° –∞–Ω–∫–µ—Ç–∞–º–∏: {players_with_forms}\n"
        f"üõç –ê–∫—Ç–∏–≤–Ω—ã—Ö –ª–æ—Ç–æ–≤: {active_lots}\n"
        f"‚úÖ –ü—Ä–æ–¥–∞–Ω–Ω—ã—Ö –ª–æ—Ç–æ–≤: {sold_lots}\n"
        f"üí∞ –û–±—â–∏–π –±–∞–ª–∞–Ω—Å: {format_number(total_balance)} –º–æ–Ω–µ—Ç\n"
        f"üí∏ –í—Å–µ–≥–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: {total_transactions}\n\n"
        [cite_start]f"üèÜ –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤ –ø–æ –±–∞–ª–∞–Ω—Å—É:\n{top_text}" # [cite: 20]
    )
    
    await callback.message.edit_text(
        stats_text,
        reply_markup=InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="üîÑ –û–±–Ω–æ–≤–∏—Ç—å", callback_data="admin_stats")],
            [InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥", callback_data="admin_menu")]
        ])
    )
    await callback.answer()

# ----------------- –ê–¥–º–∏–Ω: –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∞–Ω–∫–µ—Ç -----------------

@dp.callback_query(F.data.startswith("approve_"))
[cite_start]async def approve_login(callback: CallbackQuery): # [cite: 95]
    if not is_admin(callback.from_user.id):
        await callback.answer("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è")
        [cite_start]return # [cite: 96]
    
    user_id = int(callback.data.split("_")[1])
    if user_id not in pending_logins:
        await callback.answer("–ê–Ω–∫–µ—Ç–∞ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        return
    
    player_form = pending_logins[user_id]
    player_name = player_form.split('\n')[0].strip()
    
    player = get_player(user_id)
    if player:
        [cite_start]conn = sqlite3.connect('rp_market.db') # [cite: 97]
        cursor = conn.cursor()
        [cite_start]cursor.execute("UPDATE players SET player_form = ? WHERE user_id = ?", (player_form, user_id)) # [cite: 98]
        conn.commit()
        conn.close()
        try:
            [cite_start]await bot.send_message(user_id, "‚úÖ –í–∞—à–∞ –∞–Ω–∫–µ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /menu –¥–ª—è –≤—Ö–æ–¥–∞ –≤ –º–µ–Ω—é.") # [cite: 99]
        except: pass
    else:
        add_player(user_id, player_name, player_form, 0)
        try:
            [cite_start]await bot.send_message(user_id, "‚úÖ –í–∞—à–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /menu –¥–ª—è –≤—Ö–æ–¥–∞ –≤ —Å–∏—Å—Ç–µ–º—É.") # [cite: 100]
        except: pass
    
    del pending_logins[user_id]
    [cite_start]await callback.message.edit_text(callback.message.text + "\n\n‚úÖ –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–û") # [cite: 101]
    await callback.answer("–ê–Ω–∫–µ—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞")

@dp.callback_query(F.data.startswith("deny_"))
[cite_start]async def deny_login(callback: CallbackQuery): # [cite: 101]
    if not is_admin(callback.from_user.id):
        await callback.answer("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è")
        return
    
    user_id = int(callback.data.split("_")[1])
    if user_id not in pending_logins:
        await callback.answer("–ê–Ω–∫–µ—Ç–∞ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        return
    
    try:
        [cite_start]await bot.send_message(user_id, "‚ùå –í–∞—à–∞ –∞–Ω–∫–µ—Ç–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞.\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–≤—É—é, –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω—É—é –∞–Ω–∫–µ—Ç—É.") # [cite: 102]
    except: pass
    
    del pending_logins[user_id]
    await callback.message.edit_text(callback.message.text + "\n\n‚ùå –û–¢–ö–õ–û–ù–ï–ù–û")
    await callback.answer("–ê–Ω–∫–µ—Ç–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞")


# =============================================================================
# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Å–æ—Å—Ç–æ—è–Ω–∏—è—Ö (FSM)
# =============================================================================

# ----------------- –ü—Ä–æ—Ü–µ—Å—Å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ -----------------

@dp.message(StateFilter(ItemStates.waiting_for_image), F.photo)
[cite_start]async def handle_item_image(message: Message, state: FSMContext): # [cite: 3]
    photo = message.photo[-1]
    await state.update_data(image_file_id=photo.file_id)
    await message.answer("üìù –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞:")
    await state.set_state(ItemStates.waiting_for_name)

@dp.message(StateFilter(ItemStates.waiting_for_name), F.text)
[cite_start]async def handle_item_name(message: Message, state: FSMContext): # [cite: 3]
    await state.update_data(item_name=message.text)
    await message.answer("üìã –í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞:")
    await state.set_state(ItemStates.waiting_for_description)

@dp.message(StateFilter(ItemStates.waiting_for_description), F.text)
[cite_start]async def handle_item_description(message: Message, state: FSMContext): # [cite: 3]
    [cite_start]await state.update_data(item_description=message.text) # [cite: 4]
    await message.answer("üí∞ –í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É —Ç–æ–≤–∞—Ä–∞ (—Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ):")
    await state.set_state(ItemStates.waiting_for_price)

@dp.message(StateFilter(ItemStates.waiting_for_price), F.text)
[cite_start]async def handle_item_price(message: Message, state: FSMContext): # [cite: 4]
    try:
        price = int(message.text)
        if price <= 0:
            await message.answer("‚ùå –¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º!")
            return
        
        [cite_start]data = await state.get_data() # [cite: 5]
        
        lot_id = create_lot(message.from_user.id, data['item_name'], data['item_description'], price, data['image_file_id'])
        
        [cite_start]player = get_player(message.from_user.id) # [cite: 6]
        caption = (
            f"üõç **{data['item_name']}**\n\n"
            f"üìã {data['item_description']}\n\n"
            f"üí∞ –¶–µ–Ω–∞: {format_number(price)} –∑–æ–ª–æ—Ç—ã—Ö –º–æ–Ω–µ—Ç\n"
            f"üë§ –ü—Ä–æ–¥–∞–≤–µ—Ü: {player[1]}\n\n"
            [cite_start]f"üÜî –õ–æ—Ç #{lot_id}" # [cite: 7]
        )
        
        keyboard = InlineKeyboardMarkup(inline_keyboard=[[InlineKeyboardButton(text="üí∞ –ö—É–ø–∏—Ç—å", callback_data=f"buy_{lot_id}")]])
        
        try:
            sent_message = await bot.send_photo(
                [cite_start]MARKET_CHANNEL_ID, # [cite: 8]
                data['image_file_id'],
                caption=caption,
                reply_markup=keyboard,
                parse_mode="Markdown"
            )
            [cite_start]update_lot_message_id(lot_id, sent_message.message_id) # [cite: 9]
            
            await message.answer(
                f"‚úÖ –¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ —Ä—ã–Ω–æ–∫!\nüÜî –ù–æ–º–µ—Ä –ª–æ—Ç–∞: {lot_id}",
                [cite_start]reply_markup=InlineKeyboardMarkup(inline_keyboard=[[InlineKeyboardButton(text="üîô –í –º–µ–Ω—é", callback_data="main_menu")]]) # [cite: 10]
            )
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –∫–∞–Ω–∞–ª: {e}")
            await message.answer("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–∞–Ω–∞–ª–µ!")
        
        [cite_start]await state.clear() # [cite: 11]
        
    except ValueError:
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É!")

# ----------------- –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å: FSM -----------------

@dp.message(StateFilter(AdminStates.waiting_for_user_id), F.text)
[cite_start]async def handle_admin_user_id(message: Message, state: FSMContext): # [cite: 30]
    if not is_admin(message.from_user.id):
        await state.clear()
        return
    
    try:
        user_id = int(message.text)
        data = await state.get_data()
        [cite_start]action = data.get("action") # [cite: 31]
        
        if action == "add_money" or action == "remove_money":
            await state.update_data(target_user_id=user_id)
            prompt = "–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è:" if action == "add_money" else "–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è:"
            [cite_start]await message.answer(prompt) # [cite: 32]
            await state.set_state(AdminStates.waiting_for_amount)
        else: # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞
            await state.update_data(target_user_id=user_id)
            await message.answer("üë§ –í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏–≥—Ä–æ–∫–∞:")
            await state.set_state(AdminStates.waiting_for_player_name)
            
    except ValueError:
        [cite_start]await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!") # [cite: 33]

@dp.message(StateFilter(AdminStates.waiting_for_amount), F.text)
[cite_start]async def handle_admin_amount(message: Message, state: FSMContext): # [cite: 33]
    if not is_admin(message.from_user.id):
        await state.clear()
        return
    
    try:
        amount = int(message.text)
        data = await state.get_data()
        user_id = data["target_user_id"]
        action = data.get("action")
        
        [cite_start]player = get_player(user_id) # [cite: 34]
        if not player:
            await message.answer(f"‚ùå –ò–≥—Ä–æ–∫ —Å ID {user_id} –Ω–µ –Ω–∞–π–¥–µ–Ω!")
            await state.clear()
            return
        
        if action == "remove_money":
            [cite_start]amount = -amount # [cite: 35]
        
        update_balance(user_id, amount)
        
        desc = f"–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è: {'–ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ' if amount > 0 else '—Å–ø–∏—Å–∞–Ω–∏–µ'}"
        [cite_start]add_transaction(message.from_user.id, user_id, abs(amount), "admin_op", desc) # [cite: 36]
        
        operation = "–ø–æ–ø–æ–ª–Ω–µ–Ω" if amount > 0 else "—Å–ø–∏—Å–∞–Ω"
        await message.answer(f"‚úÖ –ë–∞–ª–∞–Ω—Å –∏–≥—Ä–æ–∫–∞ {player[1]} {operation} –Ω–∞ {format_number(abs(amount))} –º–æ–Ω–µ—Ç!")
        
        try:
            [cite_start]await bot.send_message(user_id, f"üí∞ –í–∞—à –±–∞–ª–∞–Ω—Å {'–ø–æ–ø–æ–ª–Ω–µ–Ω' if amount > 0 else '—Å–ø–∏—Å–∞–Ω'} –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –Ω–∞ {format_number(abs(amount))} –º–æ–Ω–µ—Ç") # [cite: 37]
        except: pass
        
        await state.clear()
        
    except ValueError:
        [cite_start]await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É!") # [cite: 38]

@dp.message(StateFilter(AdminStates.waiting_for_player_name), F.text)
[cite_start]async def handle_admin_player_name(message: Message, state: FSMContext): # [cite: 38]
    if not is_admin(message.from_user.id):
        await state.clear()
        return
    await state.update_data(player_name=message.text)
    await message.answer("üí∞ –í–≤–µ–¥–∏—Ç–µ –Ω–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å:")
    await state.set_state(AdminStates.waiting_for_initial_balance)

@dp.message(StateFilter(AdminStates.waiting_for_initial_balance), F.text)
[cite_start]async def handle_admin_initial_balance(message: Message, state: FSMContext): # [cite: 38]
    if not is_admin(message.from_user.id):
        await state.clear()
        [cite_start]return # [cite: 39]

    try:
        balance = int(message.text)
        if balance < 0:
            await message.answer("‚ùå –ë–∞–ª–∞–Ω—Å –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º!")
            return
            
        data = await state.get_data()
        add_player(data["target_user_id"], data["player_name"], "–î–æ–±–∞–≤–ª–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º", balance)

        [cite_start]await message.answer(f"‚úÖ –ò–≥—Ä–æ–∫ {data['player_name']} –¥–æ–±–∞–≤–ª–µ–Ω —Å –±–∞–ª–∞–Ω—Å–æ–º {format_number(balance)} –º–æ–Ω–µ—Ç!") # [cite: 40]
        
        try:
            await bot.send_message(
                data["target_user_id"],
                f"‚úÖ –í—ã –±—ã–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ —Å–∏—Å—Ç–µ–º—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º!\n"
                f"üë§ –ò–º—è: {data['player_name']}\n"
                f"üí∞ –ë–∞–ª–∞–Ω—Å: {format_number(balance)} –º–æ–Ω–µ—Ç\n"
                [cite_start]f"–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /menu –¥–ª—è –≤—Ö–æ–¥–∞ –≤ —Å–∏—Å—Ç–µ–º—É." # [cite: 42]
            [cite_start]) # [cite: 41]
        except: pass
        
        await state.clear()

    except ValueError:
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É!")

# ----------------- –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –≤–≤–æ–¥–∞ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏—è—Ö -----------------

@dp.message(StateFilter(ItemStates.waiting_for_image))
[cite_start]async def handle_wrong_image(message: Message): # [cite: 11]
    await message.answer("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é —Ç–æ–≤–∞—Ä–∞!")

@dp.message(StateFilter(ItemStates.waiting_for_name))
async def handle_wrong_name(message: Message):
    await message.answer("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ —Ç–µ–∫—Å—Ç–æ–º!")

@dp.message(StateFilter(ItemStates.waiting_for_description))
async def handle_wrong_description(message: Message):
    await message.answer("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ —Ç–µ–∫—Å—Ç–æ–º!")

@dp.message(StateFilter(ItemStates.waiting_for_price))
async def handle_wrong_price(message: Message):
    await message.answer("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É —Ç–æ–≤–∞—Ä–∞ —á–∏—Å–ª–æ–º!")

# =============================================================================
# –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞–Ω–∫–µ—Ç –∏ –ø—Ä–æ—á–∏—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
# =============================================================================

@dp.message(F.text & ~F.text.startswith('/'))
[cite_start]async def handle_text_message(message: Message): # [cite: 84]
    user_id = message.from_user.id
    player = get_player(user_id)
    
    # –ï—Å–ª–∏ –∞–Ω–∫–µ—Ç–∞ —É–∂–µ –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏
    if user_id in pending_logins:
        await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–∂–∏–¥–∞–π—Ç–µ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—è –≤–∞—à–µ–π –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∞–Ω–∫–µ—Ç—ã.")
        return

    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –∏ –∏–º–µ–µ—Ç –∞–Ω–∫–µ—Ç—É, —ç—Ç–æ –æ–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    if player and player[4]:
        [cite_start]await message.answer("‚ÑπÔ∏è –î–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –±–æ—Ç–æ–º –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä /menu.") # [cite: 23]
        return

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–≤–æ–π –∞–Ω–∫–µ—Ç—ã
    [cite_start]pending_logins[user_id] = message.text # [cite: 85]
    admin_message = (
        f"üìù –ù–æ–≤–∞—è –∞–Ω–∫–µ—Ç–∞ –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ\n\n"
        f"–û—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {message.from_user.full_name} (@{message.from_user.username})\n"
        f"ID: {user_id}\n\n"
        f"üìã –¢–µ–∫—Å—Ç –∞–Ω–∫–µ—Ç—ã:\n{message.text}"
    [cite_start]) # [cite: 86]
    
    sent_to_admins = False
    for admin_id in ADMIN_IDS:
        try:
            [cite_start]await bot.send_message(admin_id, admin_message, reply_markup=mod_keyboard(user_id)) # [cite: 87]
            sent_to_admins = True
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞–¥–º–∏–Ω—É {admin_id}: {e}")
            [cite_start]continue # [cite: 88]
    
    if sent_to_admins:
        await message.answer("‚úÖ –í–∞—à–∞ –∞–Ω–∫–µ—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ. –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.")
    else:
        [cite_start]await message.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∞–Ω–∫–µ—Ç—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.") # [cite: 90]
        del pending_logins[user_id]


# =============================================================================
# –ó–∞–≤–µ—Ä—à–∞—é—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
# =============================================================================

@dp.callback_query()
[cite_start]async def handle_unknown_callback(callback: CallbackQuery): # [cite: 21]
    await callback.answer("‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞")

@dp.message()
[cite_start]async def handle_other_messages(message: Message): # [cite: 21]
    # –≠—Ç–æ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ª–æ–≤–∏—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –±—ã–ª–∏ –ø–æ–π–º–∞–Ω—ã —Ä–∞–Ω–µ–µ.
    # –û–Ω –¥–æ–ª–∂–µ–Ω —Å—Ç–æ—è—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–º —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π.
    [cite_start]await message.answer("‚ÑπÔ∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /help –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥.") # [cite: 23]


# =============================================================================
# –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –∏ –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞
# =============================================================================

[cite_start]async def main(): # [cite: 106]
    init_db()
    await set_commands()
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!")
    await dp.start_polling(bot)

if __name__ == "__main__":
    try:
        [cite_start]asyncio.run(main()) # [cite: 107]
    except KeyboardInterrupt:
        print("–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")